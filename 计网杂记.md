# TCP

![image-20210818151507744](C:\Users\Seraph\AppData\Roaming\Typora\typora-user-images\image-20210818151507744.png)

TCP是面向连接的、可靠的、基于字节流的传输层通信协议。



### TCP连接

连接的定义：用于保证**可靠性**和**流量控制**而维护的某些状态信息，包括Socket、序列号和窗口大小。

1. Socket：由IP地址和端口号组成
2. 序列号：用于解决乱序问题
3. 窗口大小：用来做流量控制

建立一个TCP连接需要Client和Server达成以上三个信息的共识。

通过TCP四元组可以确定唯一连接：**源地址、源端口、目的地址、目的端口**。

源地址和目的地址位于IP头部中，源端口和目的端口位于TCP头中。



### TCP和UDP的区别：

1. 连接
   1. TCP面向连接，传输数据前需要先建立连接。
   2. UDP无连接，即刻传输数据。
2. 服务对象
   1. TCP是一对一的两点服务
   2. UDP支持一对一、一对多、多对多
3. 可靠性
   1. TCP是可靠的数据交付，保证数据无差错、不丢失、不重复、按序到达。
   2. UDP是尽最大努力交付，不保证数据的可靠性。
4. 拥塞控制、流量控制
   1. TCP有拥塞控制和流量控制机制
   2. UDP没有
5. 首部开销
   1. TCP首部较长，一般20个字节，开销大
   2. UDP首部只有8个字节，且固定不变，开销小
6. 传输方式
   1. TCP是流式传输，没有边界，保证顺序和可靠 ？
   2. UDP是一个包一个包地发送，有边界，可能丢包和乱序
7. 分片不同
   1. TCP数据大小如果大于MSS(Maximum Segement Size，最大报文段长度)，则会在传输层进行分片和组装
   2. UDP数据大小如果大于MTU(Maximum Transmission Unit，最大传输单元，应用于数据链路层)，则会在IP层分片和组装



TCP的应用场景：

1. FTP文件传输
2. HTTP/HTTPS

UDP的应用场景：

1. DNS、SNMP
2. 音视频
3. 广播



### TCP的三次握手

![image-20210818154824694](C:\Users\Seraph\AppData\Roaming\Typora\typora-user-images\image-20210818154824694.png)



第三次握手是可以携带数据的 => 客户端已确认服务器的收发能力是正常的。



为什么需要三次握手？

1. **避免历史连接**，防止旧的重复连接初始化造成混乱
2. **同步双方初始序列号**（序列号作用：接收方去重、接收方按序接收、发送方用以标识哪些数据包已被接收），通过三次握手确保双方的促使序列号都被可靠地同步
3. **避免资源浪费**：如果只有两次握手，Server在接收到Client的SYN报文后就得建立连接，在网络拥塞的情况下，可能有多个Client的SYN报文先后到达Server，那么Server就会建立多个冗余的无效连接，造成资源的浪费

**两次握手 => 无法防止历史连接的简历，无法可靠地同步初始序列号，会造成双方资源的浪费**

**四次握手 => 三次握手已经可以建立可靠连接，不需要四次**



### TCP四次挥手

![image-20210819164114952](C:\Users\Seraph\AppData\Roaming\Typora\typora-user-images\image-20210819164114952.png)

